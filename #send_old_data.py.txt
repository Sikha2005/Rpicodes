#send_old_data.py
import sqlite3
import requests
import socket
import time

DB_PATH = "/home/raspberrypi/iot_data.db"
SERVER_URL = "http://192.168.137.22:6000/cloud"
def internet_available():
    try:
        socket.create_connection(("8.8.8.8", 53), timeout=2)
        return True
    except:
        return False

def send_old_data():
    if not internet_available():
        print("Internet OFF → storing only")
        return

    conn = sqlite3.connect(DB_PATH)
    cursor = conn.cursor()

    cursor.execute("""
        SELECT id, temperature, humidity, gas
        FROM live_data
        WHERE sent = 0
 ORDER BY id ASC
        LIMIT 10
    """)

    rows = cursor.fetchall()

    for row in rows:
        row_id, temp, hum, gas = row

        payload = {
            "temperature": temp,
            "humidity": hum,
            "gas": gas
        }

        try:
            r = requests.post(SERVER_URL, json=payload, timeout=5)

            if r.status_code == 200:
                cursor.execute(
                    "UPDATE live_data SET sent = 1 WHERE id = ?",
                    (row_id,)
                )
                conn.commit()
                print(f" Sent OLD data ID {row_id}")
             else:
                print("⚠️server error, stop sending")
                break

        except:
            print(" Internet dropped again")
            break

    conn.close()

while True:
    send_old_data()
    time.sleep(10)